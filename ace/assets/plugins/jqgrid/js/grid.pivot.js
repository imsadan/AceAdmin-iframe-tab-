(function(a){if(typeof define==="function"&&define.amd){define(["jquery","./grid.base","./grid.grouping"],a)}else{a(jQuery)}}(function(a){function b(d,c){var e,h,g=[],f;if(!this||typeof d!=="function"||(d instanceof RegExp)){throw new TypeError()}f=this.length;for(e=0;e<f;e++){if(this.hasOwnProperty(e)){h=this[e];if(d.call(c,h,e,this)){g.push(h);break}}}return g}a.assocArraySize=function(d){var e=0,c;for(c in d){if(d.hasOwnProperty(c)){e++}}return e};a.jgrid.extend({pivotSetup:function(d,j){var c=[],k=[],l=[],h=[],g=[],e={grouping:true,groupingView:{groupField:[],groupSummary:[],groupSummaryPos:[]}},f=[],i=a.extend({rowTotals:false,rowTotalsText:"Total",colTotals:false,groupSummary:true,groupSummaryPos:"header",frozenStaticCols:false},j||{});this.each(function(){var I,J,x,K=d.length,O,Q,m,M,E,H=0;function u(r,T,S){var U;U=b.call(r,T,S);return U.length>0?U[0]:null}function v(T,S){var U=0,V=true,r;for(r in T){if(T.hasOwnProperty(r)){if(T[r]!=this[U]){V=false;break}U++;if(U>=this.length){break}}}if(V){J=S}return V}function o(T,W,S,U,r){var V;switch(T){case"sum":V=parseFloat(W||0)+parseFloat((U[S]||0));break;case"count":if(W===""||W==null){W=0}if(U.hasOwnProperty(S)){V=W+1}else{V=0}break;case"min":if(W===""||W==null){V=parseFloat(U[S]||0)}else{V=Math.min(parseFloat(W),parseFloat(U[S]||0))}break;case"max":if(W===""||W==null){V=parseFloat(U[S]||0)}else{V=Math.max(parseFloat(W),parseFloat(U[S]||0))}break;case"avg":V=(parseFloat(W||0)*(r-1)+parseFloat(U[S]||0))/r;break}return V}function n(aa,r,ad,T){var S=r.length,V,Y,W,X,Z="",ab=[];if(a.isArray(ad)){X=ad.length;ab=ad}else{X=1;ab[0]=ad}h=[];g=[];h.root=0;if(!!!T._count){T._count=1}else{T._count++}for(W=0;W<X;W++){var ac=[],ae;for(V=0;V<S;V++){if(ad==null){Y=a.trim(r[V].member)+"_"+r[V].aggregator;ae=Y;ab[0]=r[V].label||(r[V].aggregator+" "+a.trim(r[V].member))}else{ae=ad[W].replace(/\s+/g,"");try{Y=(S===1?Z+ae:Z+ae+"_"+r[V].aggregator+"_"+String(V))}catch(U){}ab[W]=ad[W]}Y=!isNaN(parseInt(Y,10))?Y+" ":Y;T[Y]=ac[Y]=o(r[V].aggregator,T[Y],r[V].member,aa,T._count)}Z+=ad[W].replace(/\s+/g,"");h[Y]=ac;g[Y]=ab[W]}return T}if(i.rowTotals&&i.yDimension.length>0){var s=i.yDimension[0].dataName;i.yDimension.splice(0,0,{dataName:s});i.yDimension[0].converter=function(){return"_r_Totals"}}O=a.isArray(i.xDimension)?i.xDimension.length:0;Q=i.yDimension.length;m=a.isArray(i.aggregates)?i.aggregates.length:0;if(O===0||m===0){throw ("xDimension or aggregates optiona are not set!")}var p;for(x=0;x<O;x++){p={name:i.xDimension[x].dataName,frozen:i.frozenStaticCols};if(i.xDimension[x].isGroupField==null){i.xDimension[x].isGroupField=true}p=a.extend(true,p,i.xDimension[x]);c.push(p)}var w=O-1,N={};while(H<K){I=d[H];var P=[];var R=[];M={};x=0;do{P[x]=a.trim(I[i.xDimension[x].dataName]);M[i.xDimension[x].dataName]=P[x];x++}while(x<O);var z=0;J=-1;E=u(k,v,P);if(!E){z=0;if(Q>=1){for(z=0;z<Q;z++){R[z]=a.trim(I[i.yDimension[z].dataName]);if(i.yDimension[z].converter&&a.isFunction(i.yDimension[z].converter)){R[z]=i.yDimension[z].converter.call(this,R[z],P,R)}}M=n(I,i.aggregates,R,M)}else{if(Q===0){M=n(I,i.aggregates,null,M)}}k.push(M)}else{if(J>=0){z=0;if(Q>=1){for(z=0;z<Q;z++){R[z]=a.trim(I[i.yDimension[z].dataName]);if(i.yDimension[z].converter&&a.isFunction(i.yDimension[z].converter)){R[z]=i.yDimension[z].converter.call(this,R[z],P,R)}}E=n(I,i.aggregates,R,E)}else{if(Q===0){E=n(I,i.aggregates,null,E)}}k[J]=E}}var A=0,q=null,t=null,B;for(B in h){if(h.hasOwnProperty(B)){if(A===0){if(!N.children||N.children===undefined){N={text:B,level:0,children:[],label:B}}q=N.children}else{t=null;for(x=0;x<q.length;x++){if(q[x].text===B){t=q[x];break}}if(t){q=t.children}else{q.push({children:[],text:B,level:A,fields:h[B],label:g[B]});q=q[q.length-1].children}}A++}}H++}var C=[],y=c.length,L=y;if(Q>0){f[Q-1]={useColSpanStyle:false,groupHeaders:[]}}function D(U){var Z,V,X,W,r;for(X in U){if(U.hasOwnProperty(X)){if(typeof U[X]!=="object"){if(X==="level"){if(C[U.level]===undefined){C[U.level]="";if(U.level>0&&U.text.indexOf("_r_Totals")===-1){f[U.level-1]={useColSpanStyle:false,groupHeaders:[]}}}if(C[U.level]!==U.text&&U.children.length&&U.text.indexOf("_r_Totals")===-1){if(U.level>0){f[U.level-1].groupHeaders.push({titleText:U.label,numberOfColumns:0});var S=f[U.level-1].groupHeaders.length-1,T=S===0?L:y;if(U.level-1===(i.rowTotals?1:0)){if(S>0){var aa=0;for(var Y=0;Y<S;Y++){aa+=f[U.level-1].groupHeaders[Y].numberOfColumns}if(aa){T=aa+O}}}if(c[T]){f[U.level-1].groupHeaders[S].startColumnName=c[T].name;f[U.level-1].groupHeaders[S].numberOfColumns=c.length-T}y=c.length}}C[U.level]=U.text}if(U.level===Q&&X==="level"&&Q>0){if(m>1){var ab=1;for(Z in U.fields){if(U.fields.hasOwnProperty(Z)){if(ab===1){f[Q-1].groupHeaders.push({startColumnName:Z,numberOfColumns:1,titleText:U.label||U.text})}ab++}}f[Q-1].groupHeaders[f[Q-1].groupHeaders.length-1].numberOfColumns=ab-1}else{f.splice(Q-1,1)}}}if(U[X]!=null&&typeof U[X]==="object"){D(U[X])}if(X==="level"){if(U.level>0&&(U.level===(Q===0?U.level:Q)||C[U.level].indexOf("_r_Totals")!==-1)){V=0;for(Z in U.fields){if(U.fields.hasOwnProperty(Z)){r={};for(W in i.aggregates[V]){if(i.aggregates[V].hasOwnProperty(W)){switch(W){case"member":case"label":case"aggregator":break;default:r[W]=i.aggregates[V][W]}}}if(m>1){r.name=Z;r.label=i.aggregates[V].label||U.label}else{r.name=U.text;r.label=U.text==="_r_Totals"?i.rowTotalsText:U.label}c.push(r);V++}}}}}}}D(N);var F;if(i.colTotals){var G=k.length;while(G--){for(x=O;x<c.length;x++){F=c[x].name;if(!l[F]){l[F]=parseFloat(k[G][F]||0)}else{l[F]+=parseFloat(k[G][F]||0)}}}}if(w>0){for(x=0;x<w;x++){if(c[x].isGroupField){e.groupingView.groupField.push(c[x].name);e.groupingView.groupSummary.push(i.groupSummary);e.groupingView.groupSummaryPos.push(i.groupSummaryPos)}}}else{e.grouping=false}e.sortname=c[w].name;e.groupingView.hideFirstGroupCol=true});return{colModel:c,rows:k,groupOptions:e,groupHeaders:f,summary:l}},jqPivot:function(d,f,e,c){return this.each(function(){var g=this;function h(j){var o=jQuery(g).jqGrid("pivotSetup",j,f),k=a.assocArraySize(o.summary)>0?true:false,p=a.jgrid.from.call(g,o.rows),m,q,r,n;if(f.ignoreCase){p=p.ignoreCase()}for(m=0;m<o.groupOptions.groupingView.groupField.length;m++){q=f.xDimension[m].sortorder?f.xDimension[m].sortorder:"asc";r=f.xDimension[m].sorttype?f.xDimension[m].sorttype:"text";p.orderBy(o.groupOptions.groupingView.groupField[m],q,r,"",r)}n=f.xDimension.length;if(o.groupOptions.sortname&&n){q=f.xDimension[n-1].sortorder?f.xDimension[n-1].sortorder:"asc";r=f.xDimension[n-1].sorttype?f.xDimension[n-1].sorttype:"text";p.orderBy(o.groupOptions.sortname,q,r,"",r)}jQuery(g).jqGrid(a.extend(true,{datastr:a.extend(p.select(),k?{userdata:o.summary}:{}),datatype:"jsonstring",footerrow:k,userDataOnFooter:k,colModel:o.colModel,viewrecords:true,sortname:f.xDimension[0].dataName},o.groupOptions,e||{}));var l=o.groupHeaders;if(l.length){for(m=0;m<l.length;m++){if(l[m]&&l[m].groupHeaders.length){jQuery(g).jqGrid("setGroupHeaders",l[m])}}}if(f.frozenStaticCols){jQuery(g).jqGrid("setFrozenColumns")}}if(typeof d==="string"){a.ajax(a.extend({url:d,dataType:"json",success:function(i){h(a.jgrid.getAccessor(i,c&&c.reader?c.reader:"rows"))}},c||{}))}else{h(d)}})}})}));