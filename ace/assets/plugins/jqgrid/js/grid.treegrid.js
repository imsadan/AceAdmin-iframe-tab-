(function(a){if(typeof define==="function"&&define.amd){define(["jquery","./grid.base"],a)}else{a(jQuery)}}(function(a){a.jgrid.extend({setTreeNode:function(b,c){return this.each(function(){var d=this;if(!d.grid||!d.p.treeGrid){return}var j=d.p.expColInd,i=d.p.treeReader.expanded_field,n=d.p.treeReader.leaf_field,p=d.p.treeReader.level_field,k=d.p.treeReader.icon_field,t=d.p.treeReader.loaded,r,u,f,l,s,v,o,q,e=a.jgrid.styleUI[(d.p.styleUI||"jQueryUI")].common;while(b<c){var m=a.jgrid.stripPref(d.p.idPrefix,d.rows[b].id),g=d.p._index[m],h;o=d.p.data[g];if(d.p.treeGridModel==="nested"){if(!o[n]){r=parseInt(o[d.p.treeReader.left_field],10);u=parseInt(o[d.p.treeReader.right_field],10);o[n]=(u===r+1)?"true":"false";d.rows[b].cells[d.p._treeleafpos].innerHTML=o[n]}}f=parseInt(o[p],10);if(d.p.tree_root_level===0){l=f+1;s=f}else{l=f;s=f-1}v="<div class='tree-wrap tree-wrap-"+d.p.direction+"' style='width:"+(l*18)+"px;'>";v+="<div style='"+(d.p.direction==="rtl"?"right:":"left:")+(s*18)+"px;' class='"+e.icon_base+" ";if(o[t]!==undefined){if(o[t]==="true"||o[t]===true){o[t]=true}else{o[t]=false}}if(o[n]==="true"||o[n]===true){v+=((o[k]!==undefined&&o[k]!=="")?o[k]:d.p.treeIcons.leaf)+" tree-leaf treeclick";o[n]=true;q="leaf"}else{o[n]=false;q=""}o[i]=((o[i]==="true"||o[i]===true)?true:false)&&(o[t]||o[t]===undefined);if(o[i]===false){v+=((o[n]===true)?"'":d.p.treeIcons.plus+" tree-plus treeclick'")}else{v+=((o[n]===true)?"'":d.p.treeIcons.minus+" tree-minus treeclick'")}v+="></div></div>";a(d.rows[b].cells[j]).wrapInner("<span class='cell-wrapper"+q+"'></span>").prepend(v);if(f!==parseInt(d.p.tree_root_level,10)){h=a(d).jqGrid("isVisibleNode",o);if(!h){a(d.rows[b]).css("display","none")}}a(d.rows[b].cells[j]).find("div.treeclick").bind("click",function(w){var z=w.target||w.srcElement,x=a.jgrid.stripPref(d.p.idPrefix,a(z,d.rows).closest("tr.jqgrow")[0].id),y=d.p._index[x];if(!d.p.data[y][n]){if(d.p.data[y][i]){a(d).jqGrid("collapseRow",d.p.data[y]);a(d).jqGrid("collapseNode",d.p.data[y])}else{a(d).jqGrid("expandRow",d.p.data[y]);a(d).jqGrid("expandNode",d.p.data[y])}}return false});if(d.p.ExpandColClick===true){a(d.rows[b].cells[j]).find("span.cell-wrapper").css("cursor","pointer").bind("click",function(w){var z=w.target||w.srcElement,x=a.jgrid.stripPref(d.p.idPrefix,a(z,d.rows).closest("tr.jqgrow")[0].id),y=d.p._index[x];if(!d.p.data[y][n]){if(d.p.data[y][i]){a(d).jqGrid("collapseRow",d.p.data[y]);a(d).jqGrid("collapseNode",d.p.data[y])}else{a(d).jqGrid("expandRow",d.p.data[y]);a(d).jqGrid("expandNode",d.p.data[y])}}a(d).jqGrid("setSelection",x);return false})}b++}})},setTreeGrid:function(){return this.each(function(){var b=this,f=0,j,e=false,h,g,k,d=[],c=a.jgrid.styleUI[(b.p.styleUI||"jQueryUI")].treegrid;if(!b.p.treeGrid){return}if(!b.p.treedatatype){a.extend(b.p,{treedatatype:b.p.datatype})}if(b.p.loadonce){b.p.treedatatype="local"}b.p.subGrid=false;b.p.altRows=false;b.p.pgbuttons=false;b.p.pginput=false;b.p.gridview=true;if(b.p.rowTotal===null){b.p.rowNum=10000}b.p.multiselect=false;b.p.rowList=[];b.p.expColInd=0;j=c.icon_plus;if(b.p.styleUI==="jQueryUI"){j+=(b.p.direction==="rtl"?"w":"e")}b.p.treeIcons=a.extend({plus:j,minus:c.icon_minus,leaf:c.icon_leaf},b.p.treeIcons||{});if(b.p.treeGridModel==="nested"){b.p.treeReader=a.extend({level_field:"level",left_field:"lft",right_field:"rgt",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",icon_field:"icon"},b.p.treeReader)}else{if(b.p.treeGridModel==="adjacency"){b.p.treeReader=a.extend({level_field:"level",parent_id_field:"parent",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",icon_field:"icon"},b.p.treeReader)}}for(g in b.p.colModel){if(b.p.colModel.hasOwnProperty(g)){h=b.p.colModel[g].name;if(h===b.p.ExpandColumn&&!e){e=true;b.p.expColInd=f}f++;for(k in b.p.treeReader){if(b.p.treeReader.hasOwnProperty(k)&&b.p.treeReader[k]===h){d.push(h)}}}}a.each(b.p.treeReader,function(i,l){if(l&&a.inArray(l,d)===-1){if(i==="leaf_field"){b.p._treeleafpos=f}f++;b.p.colNames.push(l);b.p.colModel.push({name:l,width:1,hidden:true,sortable:false,resizable:false,hidedlg:true,editable:true,search:false})}})})},expandRow:function(b){this.each(function(){var c=this;if(!c.grid||!c.p.treeGrid){return}var d=a(c).jqGrid("getNodeChildren",b),e=c.p.treeReader.expanded_field,g=b[c.p.localReader.id];var f=a.isFunction(c.p.beforeExpandTreeGridRow)?c.p.beforeExpandTreeGridRow.call(c,g,b,d):true;if(f===false){return}a(d).each(function(){var h=c.p.idPrefix+a.jgrid.getAccessor(this,c.p.localReader.id);a(a(c).jqGrid("getGridRowById",h)).css("display","");if(this[e]){a(c).jqGrid("expandRow",this)}});if(a.isFunction(c.p.afterExpandTreeGridRow)){c.p.afterExpandTreeGridRow.call(c,g,b,d)}})},collapseRow:function(b){this.each(function(){var c=this;if(!c.grid||!c.p.treeGrid){return}var d=a(c).jqGrid("getNodeChildren",b),e=c.p.treeReader.expanded_field,g=b[c.p.localReader.id];var f=a.isFunction(c.p.beforeCollapseTreeGridRow)?c.p.beforeCollapseTreeGridRow.call(c,g,b,d):true;if(f===false){return}a(d).each(function(){var h=c.p.idPrefix+a.jgrid.getAccessor(this,c.p.localReader.id);a(a(c).jqGrid("getGridRowById",h)).css("display","none");if(this[e]){a(c).jqGrid("collapseRow",this)}});if(a.isFunction(c.p.afterCollapseTreeGridRow)){c.p.afterCollapseTreeGridRow.call(c,g,b,d)}})},getRootNodes:function(b){var c=[];this.each(function(){var d=this,e,f,g;if(!d.grid||!d.p.treeGrid){return}if(typeof b!=="boolean"){b=false}if(b){g=a(d).jqGrid("getRowData",null,true)}else{g=d.p.data}switch(d.p.treeGridModel){case"nested":e=d.p.treeReader.level_field;a(g).each(function(){if(parseInt(this[e],10)===parseInt(d.p.tree_root_level,10)){if(b){c.push(d.p.data[d.p._index[this[d.p.keyName]]])}else{c.push(this)}}});break;case"adjacency":f=d.p.treeReader.parent_id_field;a(g).each(function(){if(this[f]===null||String(this[f]).toLowerCase()==="null"){if(b){c.push(d.p.data[d.p._index[this[d.p.keyName]]])}else{c.push(this)}}});break}});return c},getNodeDepth:function(b){var c=null;this.each(function(){if(!this.grid||!this.p.treeGrid){return}var d=this;switch(d.p.treeGridModel){case"nested":var e=d.p.treeReader.level_field;c=parseInt(b[e],10)-parseInt(d.p.tree_root_level,10);break;case"adjacency":c=a(d).jqGrid("getNodeAncestors",b).length;break}});return c},getNodeParent:function(b){var c=null;this.each(function(){var d=this;if(!d.grid||!d.p.treeGrid){return}switch(d.p.treeGridModel){case"nested":var j=d.p.treeReader.left_field,n=d.p.treeReader.right_field,h=d.p.treeReader.level_field,i=parseInt(b[j],10),m=parseInt(b[n],10),g=parseInt(b[h],10);a(this.p.data).each(function(){if(parseInt(this[h],10)===g-1&&parseInt(this[j],10)<i&&parseInt(this[n],10)>m){c=this;return false}});break;case"adjacency":var k=d.p.treeReader.parent_id_field,e=d.p.localReader.id,f=b[e],l=d.p._index[f];while(l--){if(d.p.data[l][e]===a.jgrid.stripPref(d.p.idPrefix,b[k])){c=d.p.data[l];break}}break}});return c},getNodeChildren:function(b){var c=[];this.each(function(){var d=this;if(!d.grid||!d.p.treeGrid){return}switch(d.p.treeGridModel){case"nested":var i=d.p.treeReader.left_field,l=d.p.treeReader.right_field,g=d.p.treeReader.level_field,h=parseInt(b[i],10),k=parseInt(b[l],10),f=parseInt(b[g],10);a(this.p.data).each(function(){if(parseInt(this[g],10)===f+1&&parseInt(this[i],10)>h&&parseInt(this[l],10)<k){c.push(this)}});break;case"adjacency":var j=d.p.treeReader.parent_id_field,e=d.p.localReader.id;a(this.p.data).each(function(){if(this[j]==a.jgrid.stripPref(d.p.idPrefix,b[e])){c.push(this)}});break}});return c},getFullTreeNode:function(c,b){var d=[];this.each(function(){var e=this,h,g=e.p.treeReader.expanded_field;if(!e.grid||!e.p.treeGrid){return}if(b==null||typeof b!=="boolean"){b=false}switch(e.p.treeGridModel){case"nested":var l=e.p.treeReader.left_field,o=e.p.treeReader.right_field,j=e.p.treeReader.level_field,k=parseInt(c[l],10),n=parseInt(c[o],10),i=parseInt(c[j],10);a(this.p.data).each(function(){if(parseInt(this[j],10)>=i&&parseInt(this[l],10)>=k&&parseInt(this[l],10)<=n){if(b){this[g]=true}d.push(this)}});break;case"adjacency":if(c){d.push(c);var m=e.p.treeReader.parent_id_field,f=e.p.localReader.id;a(this.p.data).each(function(p){h=d.length;for(p=0;p<h;p++){if(a.jgrid.stripPref(e.p.idPrefix,d[p][f])===this[m]){if(b){this[g]=true}d.push(this);break}}})}break}});return d},getNodeAncestors:function(c){var b=[];this.each(function(){if(!this.grid||!this.p.treeGrid){return}var d=a(this).jqGrid("getNodeParent",c);while(d){b.push(d);d=a(this).jqGrid("getNodeParent",d)}});return b},isVisibleNode:function(b){var c=true;this.each(function(){var d=this;if(!d.grid||!d.p.treeGrid){return}var e=a(d).jqGrid("getNodeAncestors",b),f=d.p.treeReader.expanded_field;a(e).each(function(){c=c&&this[f];if(!c){return false}})});return c},isNodeLoaded:function(b){var c;this.each(function(){var d=this;if(!d.grid||!d.p.treeGrid){return}var e=d.p.treeReader.leaf_field,f=d.p.treeReader.loaded;if(b!==undefined){if(b[f]!==undefined){c=b[f]}else{if(b[e]||a(d).jqGrid("getNodeChildren",b).length>0){c=true}else{c=false}}}else{c=false}});return c},reloadNode:function(b){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var l=this.p.localReader.id,c=this.p.selrow;a(this).jqGrid("delChildren",b[l]);var d=this.p.treeReader.expanded_field,i=this.p.treeReader.parent_id_field,h=this.p.treeReader.loaded,f=this.p.treeReader.level_field,g=this.p.treeReader.left_field,k=this.p.treeReader.right_field;var e=a.jgrid.getAccessor(b,this.p.localReader.id),j=a("#"+e,this.grid.bDiv)[0];b[d]=true;a("div.treeclick",j).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus");this.p.treeANode=j.rowIndex;this.p.datatype=this.p.treedatatype;if(this.p.treeGridModel==="nested"){a(this).jqGrid("setGridParam",{postData:{nodeid:e,n_left:b[g],n_right:b[k],n_level:b[f]}})}else{a(this).jqGrid("setGridParam",{postData:{nodeid:e,parentid:b[i],n_level:b[f]}})}a(this).trigger("reloadGrid");b[h]=true;if(this.p.treeGridModel==="nested"){a(this).jqGrid("setGridParam",{selrow:c,postData:{nodeid:"",n_left:"",n_right:"",n_level:""}})}else{a(this).jqGrid("setGridParam",{selrow:c,postData:{nodeid:"",parentid:"",n_level:""}})}})},expandNode:function(b){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var c=this.p.treeReader.expanded_field,h=this.p.treeReader.parent_id_field,g=this.p.treeReader.loaded,e=this.p.treeReader.level_field,f=this.p.treeReader.left_field,l=this.p.treeReader.right_field;if(!b[c]){var d=a.jgrid.getAccessor(b,this.p.localReader.id),j=a("#"+this.p.idPrefix+a.jgrid.jqID(d),this.grid.bDiv)[0],i=this.p._index[d],k=a.isFunction(this.p.beforeExpandTreeGridNode)?this.p.beforeExpandTreeGridNode.call(this,d,b):true;if(k===false){return}if(a(this).jqGrid("isNodeLoaded",this.p.data[i])){b[c]=true;a("div.treeclick",j).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus")}else{if(!this.grid.hDiv.loading){b[c]=true;a("div.treeclick",j).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus");this.p.treeANode=j.rowIndex;this.p.datatype=this.p.treedatatype;if(this.p.treeGridModel==="nested"){a(this).jqGrid("setGridParam",{postData:{nodeid:d,n_left:b[f],n_right:b[l],n_level:b[e]}})}else{a(this).jqGrid("setGridParam",{postData:{nodeid:d,parentid:b[h],n_level:b[e]}})}a(this).trigger("reloadGrid");b[g]=true;if(this.p.treeGridModel==="nested"){a(this).jqGrid("setGridParam",{postData:{nodeid:"",n_left:"",n_right:"",n_level:""}})}else{a(this).jqGrid("setGridParam",{postData:{nodeid:"",parentid:"",n_level:""}})}}}if(a.isFunction(this.p.afterExpandTreeGridNode)){this.p.afterExpandTreeGridNode.call(this,d,b)}}})},collapseNode:function(b){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var c=this.p.treeReader.expanded_field;if(b[c]){var d=a.jgrid.getAccessor(b,this.p.localReader.id),f=a.isFunction(this.p.beforeCollapseTreeGridNode)?this.p.beforeCollapseTreeGridNode.call(this,d,b):true,e=a("#"+this.p.idPrefix+a.jgrid.jqID(d),this.grid.bDiv)[0];b[c]=false;if(f===false){return}a("div.treeclick",e).removeClass(this.p.treeIcons.minus+" tree-minus").addClass(this.p.treeIcons.plus+" tree-plus");if(a.isFunction(this.p.afterCollapseTreeGridNode)){this.p.afterCollapseTreeGridNode.call(this,d,b)}}})},SortTree:function(d,c,e,b){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var g,h,k,l=[],f=this,j,m,n=a(this).jqGrid("getRootNodes",f.p.search);j=a.jgrid.from.call(this,n);j.orderBy(d,c,e,b);m=j.select();for(g=0,h=m.length;g<h;g++){k=m[g];l.push(k);a(this).jqGrid("collectChildrenSortTree",l,k,d,c,e,b)}a.each(l,function(o){var i=a.jgrid.getAccessor(this,f.p.localReader.id);a("#"+a.jgrid.jqID(f.p.id)+" tbody tr:eq("+o+")").after(a("tr#"+a.jgrid.jqID(i),f.grid.bDiv))});j=null;m=null;l=null})},searchTree:function(e){var b,c=e.length||0,f=[],d,h=[],g=[],j;this.each(function(){if(!this.grid||!this.p.treeGrid){return}if(c){d=this.p.localReader.id;for(b=0;b<c;b++){f=a(this).jqGrid("getNodeAncestors",e[b]);if(!f.length){f.push(e[b])}j=f[f.length-1][d];if(a.inArray(j,h)!==-1){continue}else{h.push(j)}f=a(this).jqGrid("getFullTreeNode",f[f.length-1],true);g=g.concat(f)}}});return g},collectChildrenSortTree:function(e,d,f,c,g,b){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var l,m,j,h,n,k;h=a(this).jqGrid("getNodeChildren",d);n=a.jgrid.from.call(this,h);n.orderBy(f,c,g,b);k=n.select();for(l=0,m=k.length;l<m;l++){j=k[l];e.push(j);a(this).jqGrid("collectChildrenSortTree",e,j,f,c,g,b)}})},setTreeRow:function(c,b){var d=false;this.each(function(){var e=this;if(!e.grid||!e.p.treeGrid){return}d=a(e).jqGrid("setRowData",c,b)});return d},delTreeNode:function(b){return this.each(function(){var c=this,l=c.p.localReader.id,e,g=c.p.treeReader.left_field,m=c.p.treeReader.right_field,h,n,k,f;if(!c.grid||!c.p.treeGrid){return}var j=c.p._index[b];if(j!==undefined){h=parseInt(c.p.data[j][m],10);n=h-parseInt(c.p.data[j][g],10)+1;var d=a(c).jqGrid("getFullTreeNode",c.p.data[j]);if(d.length>0){for(e=0;e<d.length;e++){a(c).jqGrid("delRowData",d[e][l])}}if(c.p.treeGridModel==="nested"){k=a.jgrid.from.call(c,c.p.data).greater(g,h,{stype:"integer"}).select();if(k.length){for(f in k){if(k.hasOwnProperty(f)){k[f][g]=parseInt(k[f][g],10)-n}}}k=a.jgrid.from.call(c,c.p.data).greater(m,h,{stype:"integer"}).select();if(k.length){for(f in k){if(k.hasOwnProperty(f)){k[f][m]=parseInt(k[f][m],10)-n}}}}}})},delChildren:function(b){return this.each(function(){var c=this,l=c.p.localReader.id,g=c.p.treeReader.left_field,m=c.p.treeReader.right_field,h,n,k,f;if(!c.grid||!c.p.treeGrid){return}var j=c.p._index[b];if(j!==undefined){h=parseInt(c.p.data[j][m],10);n=h-parseInt(c.p.data[j][g],10)+1;var d=a(c).jqGrid("getFullTreeNode",c.p.data[j]);if(d.length>0){for(var e=0;e<d.length;e++){if(d[e][l]!==b){a(c).jqGrid("delRowData",d[e][l])}}}if(c.p.treeGridModel==="nested"){k=a.jgrid.from(c.p.data).greater(g,h,{stype:"integer"}).select();if(k.length){for(f in k){if(k.hasOwnProperty(f)){k[f][g]=parseInt(k[f][g],10)-n}}}k=a.jgrid.from(c.p.data).greater(m,h,{stype:"integer"}).select();if(k.length){for(f in k){if(k.hasOwnProperty(f)){k[f][m]=parseInt(k[f][m],10)-n}}}}}})},addChildNode:function(s,v,d,e){var b=this[0];if(d){var f=b.p.treeReader.expanded_field,h=b.p.treeReader.leaf_field,n=b.p.treeReader.level_field,t=b.p.treeReader.parent_id_field,l=b.p.treeReader.left_field,B=b.p.treeReader.right_field,o=b.p.treeReader.loaded,r,w,u,x,g,m,p=0,C=v,k,q;if(e===undefined){e=false}if(s==null){g=b.p.data.length-1;if(g>=0){while(g>=0){p=Math.max(p,parseInt(b.p.data[g][b.p.localReader.id],10));g--}}s=p+1}var y=a(b).jqGrid("getInd",v);k=false;if(v===undefined||v===null||v===""){v=null;C=null;r="last";x=b.p.tree_root_level;g=b.p.data.length+1}else{r="after";w=b.p._index[v];u=b.p.data[w];v=u[b.p.localReader.id];x=parseInt(u[n],10)+1;var c=a(b).jqGrid("getFullTreeNode",u);if(c.length){g=c[c.length-1][b.p.localReader.id];C=g;g=a(b).jqGrid("getInd",C)+1}else{g=a(b).jqGrid("getInd",v)+1}if(u[h]){k=true;u[f]=true;a(b.rows[y]).find("span.cell-wrapperleaf").removeClass("cell-wrapperleaf").addClass("cell-wrapper").end().find("div.tree-leaf").removeClass(b.p.treeIcons.leaf+" tree-leaf").addClass(b.p.treeIcons.minus+" tree-minus");b.p.data[w][h]=false;u[o]=true}}m=g+1;if(d[f]===undefined){d[f]=false}if(d[o]===undefined){d[o]=false}d[n]=x;if(d[h]===undefined){d[h]=true}if(b.p.treeGridModel==="adjacency"){d[t]=v}if(b.p.treeGridModel==="nested"){var z,A,j;if(v!==null){q=parseInt(u[B],10);z=a.jgrid.from.call(b,b.p.data);z=z.greaterOrEquals(B,q,{stype:"integer"});A=z.select();if(A.length){for(j in A){if(A.hasOwnProperty(j)){A[j][l]=A[j][l]>q?parseInt(A[j][l],10)+2:A[j][l];A[j][B]=A[j][B]>=q?parseInt(A[j][B],10)+2:A[j][B]}}}d[l]=q;d[B]=q+1}else{q=parseInt(a(b).jqGrid("getCol",B,false,"max"),10);A=a.jgrid.from.call(b,b.p.data).greater(l,q,{stype:"integer"}).select();if(A.length){for(j in A){if(A.hasOwnProperty(j)){A[j][l]=parseInt(A[j][l],10)+2}}}A=a.jgrid.from.call(b,b.p.data).greater(B,q,{stype:"integer"}).select();if(A.length){for(j in A){if(A.hasOwnProperty(j)){A[j][B]=parseInt(A[j][B],10)+2}}}d[l]=q+1;d[B]=q+2}}if(v===null||a(b).jqGrid("isNodeLoaded",u)||k){a(b).jqGrid("addRowData",s,d,r,C);a(b).jqGrid("setTreeNode",g,m)}if(u&&!u[f]&&e){a(b.rows[y]).find("div.treeclick").click()}}}})}));