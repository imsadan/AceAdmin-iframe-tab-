!function(b){"function"==typeof define&&define.amd?define(["jquery","./grid.base"],b):b(jQuery)}(function(b){b.jgrid.extend({editCell:function(a,e,f){return this.each(function(){var c,d,q,r,s=this,t=b(this).jqGrid("getStyleUI",s.p.styleUI+".common","highlight",!0),u=b(this).jqGrid("getStyleUI",s.p.styleUI+".common","hover",!0),v=b(this).jqGrid("getStyleUI",s.p.styleUI+".celledit","inputClass",!0);if(s.grid&&s.p.cellEdit===!0){if(e=parseInt(e,10),s.p.selrow=s.rows[a].id,s.p.knv||b(s).jqGrid("GridNav"),s.p.savedRow.length>0){if(f===!0&&a==s.p.iRow&&e==s.p.iCol){return}b(s).jqGrid("saveCell",s.p.savedRow[0].id,s.p.savedRow[0].ic)}else{window.setTimeout(function(){b("#"+b.jgrid.jqID(s.p.knv)).attr("tabindex","-1").focus()},1)}if(r=s.p.colModel[e],c=r.name,"subgrid"!==c&&"cb"!==c&&"rn"!==c){if(q=b("td:eq("+e+")",s.rows[a]),r.editable!==!0||f!==!0||q.hasClass("not-editable-cell")||b.isFunction(s.p.isCellEditable)&&!s.p.isCellEditable.call(s,c,a,e)){parseInt(s.p.iCol,10)>=0&&parseInt(s.p.iRow,10)>=0&&b(s.rows[s.p.iRow]).removeClass("selected-row "+u).find("td:eq("+s.p.iCol+")").removeClass("edit-cell "+t),q.addClass("edit-cell "+t),b(s.rows[a]).addClass("selected-row "+u),d=q.html().replace(/\&#160\;/gi,""),b(s).triggerHandler("jqGridSelectCell",[s.rows[a].id,c,d,a,e]),b.isFunction(s.p.onSelectCell)&&s.p.onSelectCell.call(s,s.rows[a].id,c,d,a,e)}else{parseInt(s.p.iCol,10)>=0&&parseInt(s.p.iRow,10)>=0&&b(s.rows[s.p.iRow]).removeClass("selected-row "+u).find("td:eq("+s.p.iCol+")").removeClass("edit-cell "+t),b(q).addClass("edit-cell "+t),b(s.rows[a]).addClass("selected-row "+u);try{d=b.unformat.call(s,q,{rowId:s.rows[a].id,colModel:r},e)}catch(w){d=r.edittype&&"textarea"===r.edittype?b(q).text():b(q).html()}if(s.p.autoencode&&(d=b.jgrid.htmlDecode(d)),r.edittype||(r.edittype="text"),s.p.savedRow.push({id:a,ic:e,name:c,v:d}),("&nbsp;"===d||"&#160;"===d||1===d.length&&160===d.charCodeAt(0))&&(d=""),b.isFunction(s.p.formatCell)){var x=s.p.formatCell.call(s,s.rows[a].id,c,d,a,e);void 0!==x&&(d=x)}b(s).triggerHandler("jqGridBeforeEditCell",[s.rows[a].id,c,d,a,e]),b.isFunction(s.p.beforeEditCell)&&s.p.beforeEditCell.call(s,s.rows[a].id,c,d,a,e);var y=b.extend({},r.editoptions||{},{id:a+"_"+c,name:c,rowId:s.rows[a].id,oper:"edit"}),z=b.jgrid.createEl.call(s,r.edittype,y,d,!0,b.extend({},b.jgrid.ajaxOptions,s.p.ajaxSelectOptions||{}));b.inArray(r.edittype,["text","textarea","password","select"])>-1&&b(z).addClass(v),b(q).html("").append(z).attr("tabindex","0"),b.jgrid.bindEv.call(s,z,y),window.setTimeout(function(){b(z).focus()},1),b("input, select, textarea",q).bind("keydown",function(g){if(27===g.keyCode&&(b("input.hasDatepicker",q).length>0?b(".ui-datepicker").is(":hidden")?b(s).jqGrid("restoreCell",a,e):b("input.hasDatepicker",q).datepicker("hide"):b(s).jqGrid("restoreCell",a,e)),13===g.keyCode&&!g.shiftKey){return b(s).jqGrid("saveCell",a,e),!1}if(9===g.keyCode){if(s.grid.hDiv.loading){return !1}g.shiftKey?b(s).jqGrid("prevCell",a,e):b(s).jqGrid("nextCell",a,e)}g.stopPropagation()}),b(s).triggerHandler("jqGridAfterEditCell",[s.rows[a].id,c,d,a,e]),b.isFunction(s.p.afterEditCell)&&s.p.afterEditCell.call(s,s.rows[a].id,c,d,a,e)}s.p.iCol=e,s.p.iRow=a}}})},saveCell:function(a,d){return this.each(function(){var B,C=this,D=b.jgrid.getRegional(this,"errors"),E=b.jgrid.getRegional(this,"edit");if(C.grid&&C.p.cellEdit===!0){if(B=C.p.savedRow.length>=1?0:null,null!==B){var F,G,H=b("td:eq("+d+")",C.rows[a]),I=C.p.colModel[d],J=I.name,K=b.jgrid.jqID(J),L=b(H).offset();switch(I.edittype){case"select":if(I.editoptions.multiple){var M=b("#"+a+"_"+K,C.rows[a]),N=[];F=b(M).val(),F?F.join(","):F="",b("option:selected",M).each(function(e,f){N[e]=b(f).text()}),G=N.join(",")}else{F=b("#"+a+"_"+K+" option:selected",C.rows[a]).val(),G=b("#"+a+"_"+K+" option:selected",C.rows[a]).text()}I.formatter&&(G=F);break;case"checkbox":var O=["Yes","No"];I.editoptions&&(O=I.editoptions.value.split(":")),F=b("#"+a+"_"+K,C.rows[a]).is(":checked")?O[0]:O[1],G=F;break;case"password":case"text":case"textarea":case"button":F=b("#"+a+"_"+K,C.rows[a]).val(),G=F;break;case"custom":try{if(!I.editoptions||!b.isFunction(I.editoptions.custom_value)){throw"e1"}if(F=I.editoptions.custom_value.call(C,b(".customelement",H),"get"),void 0===F){throw"e2"}G=F}catch(P){"e1"===P?b.jgrid.info_dialog(D.errcap,"function 'custom_value' "+E.msg.nodefined,E.bClose,{styleUI:C.p.styleUI}):"e2"===P?b.jgrid.info_dialog(D.errcap,"function 'custom_value' "+E.msg.novalue,E.bClose,{styleUI:C.p.styleUI}):b.jgrid.info_dialog(D.errcap,P.message,E.bClose,{styleUI:C.p.styleUI})}}if(G!==C.p.savedRow[B].v){var Q=b(C).triggerHandler("jqGridBeforeSaveCell",[C.rows[a].id,J,F,a,d]);if(Q&&(F=Q,G=Q),b.isFunction(C.p.beforeSaveCell)){var R=C.p.beforeSaveCell.call(C,C.rows[a].id,J,F,a,d);R&&(F=R,G=R)}var S=b.jgrid.checkValues.call(C,F,d),T=!1;if(S[0]===!0){var U=b(C).triggerHandler("jqGridBeforeSubmitCell",[C.rows[a].id,J,F,a,d])||{};if(b.isFunction(C.p.beforeSubmitCell)&&(U=C.p.beforeSubmitCell.call(C,C.rows[a].id,J,F,a,d),U||(U={})),b("input.hasDatepicker",H).length>0&&b("input.hasDatepicker",H).datepicker("hide"),"remote"===C.p.cellsubmit){if(C.p.cellurl){var V={};C.p.autoencode&&(F=b.jgrid.htmlEncode(F)),I.editoptions&&I.editoptions.NullIfEmpty&&""===F&&(F="null",T=!0),V[J]=F;var W,X,c;c=C.p.prmNames,W=c.id,X=c.oper,V[W]=b.jgrid.stripPref(C.p.idPrefix,C.rows[a].id),V[X]=c.editoper,V=b.extend(U,V),b(C).jqGrid("progressBar",{method:"show",loadtype:C.p.loadui,htmlcontent:b.jgrid.getRegional(C,"defaults.savetext")}),C.grid.hDiv.loading=!0,b.ajax(b.extend({url:C.p.cellurl,data:b.isFunction(C.p.serializeCellData)?C.p.serializeCellData.call(C,V,J):V,type:"POST",complete:function(e,f){if(b(C).jqGrid("progressBar",{method:"hide",loadtype:C.p.loadui}),C.grid.hDiv.loading=!1,"success"===f){var g=b(C).triggerHandler("jqGridAfterSubmitCell",[C,e,V.id,J,F,a,d])||[!0,""];g[0]===!0&&b.isFunction(C.p.afterSubmitCell)&&(g=C.p.afterSubmitCell.call(C,e,V.id,J,F,a,d)),g[0]===!0?(T&&(F=""),b(H).empty(),b(C).jqGrid("setCell",C.rows[a].id,d,G,!1,!1,!0),b(H).addClass("dirty-cell"),b(C.rows[a]).addClass("edited"),b(C).triggerHandler("jqGridAfterSaveCell",[C.rows[a].id,J,F,a,d]),b.isFunction(C.p.afterSaveCell)&&C.p.afterSaveCell.call(C,C.rows[a].id,J,F,a,d),C.p.savedRow.splice(0,1)):(b.jgrid.info_dialog(D.errcap,g[1],E.bClose,{styleUI:C.p.styleUI}),C.p.restoreCellonFail&&b(C).jqGrid("restoreCell",a,d))}},error:function(e,f,g){b("#lui_"+b.jgrid.jqID(C.p.id)).hide(),C.grid.hDiv.loading=!1,b(C).triggerHandler("jqGridErrorCell",[e,f,g]),b.isFunction(C.p.errorCell)?C.p.errorCell.call(C,e,f,g):b.jgrid.info_dialog(D.errcap,e.status+" : "+e.statusText+"<br/>"+f,E.bClose,{styleUI:C.p.styleUI}),C.p.restoreCellonFail&&b(C).jqGrid("restoreCell",a,d)}},b.jgrid.ajaxOptions,C.p.ajaxCellOptions||{}))}else{try{b.jgrid.info_dialog(D.errcap,D.nourl,E.bClose,{styleUI:C.p.styleUI}),C.p.restoreCellonFail&&b(C).jqGrid("restoreCell",a,d)}catch(P){}}}"clientArray"===C.p.cellsubmit&&(b(H).empty(),b(C).jqGrid("setCell",C.rows[a].id,d,G,!1,!1,!0),b(H).addClass("dirty-cell"),b(C.rows[a]).addClass("edited"),b(C).triggerHandler("jqGridAfterSaveCell",[C.rows[a].id,J,F,a,d]),b.isFunction(C.p.afterSaveCell)&&C.p.afterSaveCell.call(C,C.rows[a].id,J,F,a,d),C.p.savedRow.splice(0,1))}else{try{window.setTimeout(function(){b.jgrid.info_dialog(D.errcap,F+" "+S[1],E.bClose,{styleUI:C.p.styleUI,top:L.top+40,left:L.left})},100),b(C).jqGrid("restoreCell",a,d)}catch(P){}}}else{b(C).jqGrid("restoreCell",a,d)}}window.setTimeout(function(){b("#"+b.jgrid.jqID(C.p.knv)).attr("tabindex","-1").focus()},0)}})},restoreCell:function(a,d){return this.each(function(){var c,h=this;if(h.grid&&h.p.cellEdit===!0){if(c=h.p.savedRow.length>=1?0:null,null!==c){var i=b("td:eq("+d+")",h.rows[a]);if(b.isFunction(b.fn.datepicker)){try{b("input.hasDatepicker",i).datepicker("hide")}catch(j){}}b(i).empty().attr("tabindex","-1"),b(h).jqGrid("setCell",h.rows[a].id,d,h.p.savedRow[c].v,!1,!1,!0),b(h).triggerHandler("jqGridAfterRestoreCell",[h.rows[a].id,h.p.savedRow[c].v,a,d]),b.isFunction(h.p.afterRestoreCell)&&h.p.afterRestoreCell.call(h,h.rows[a].id,h.p.savedRow[c].v,a,d),h.p.savedRow.splice(0,1)}window.setTimeout(function(){b("#"+h.p.knv).attr("tabindex","-1").focus()},0)}})},nextCell:function(a,d){return this.each(function(){var c,g=this,h=!1;if(g.grid&&g.p.cellEdit===!0){for(c=d+1;c<g.p.colModel.length;c++){if(g.p.colModel[c].editable===!0&&(!b.isFunction(g.p.isCellEditable)||g.p.isCellEditable.call(g,g.p.colModel[c].name,a,c))){h=c;break}}h!==!1?b(g).jqGrid("editCell",a,h,!0):g.p.savedRow.length>0&&b(g).jqGrid("saveCell",a,d)}})},prevCell:function(a,d){return this.each(function(){var c,g=this,h=!1;if(g.grid&&g.p.cellEdit===!0){for(c=d-1;c>=0;c--){if(g.p.colModel[c].editable===!0&&(!b.isFunction(g.p.isCellEditable)||g.p.isCellEditable.call(g,g.p.colModel[c].name,a,c))){h=c;break}}h!==!1?b(g).jqGrid("editCell",a,h,!0):g.p.savedRow.length>0&&b(g).jqGrid("saveCell",a,d)}})},GridNav:function(){return this.each(function(){function a(d,n,o){if("v"===o.substr(0,1)){var p=b(i.grid.bDiv)[0].clientHeight,q=b(i.grid.bDiv)[0].scrollTop,r=i.rows[d].offsetTop+i.rows[d].clientHeight,s=i.rows[d].offsetTop;"vd"===o&&r>=p&&(b(i.grid.bDiv)[0].scrollTop=b(i.grid.bDiv)[0].scrollTop+i.rows[d].clientHeight),"vu"===o&&q>s&&(b(i.grid.bDiv)[0].scrollTop=b(i.grid.bDiv)[0].scrollTop-i.rows[d].clientHeight)}if("h"===o){var t=b(i.grid.bDiv)[0].clientWidth,u=b(i.grid.bDiv)[0].scrollLeft,v=i.rows[d].cells[n].offsetLeft+i.rows[d].cells[n].clientWidth,w=i.rows[d].cells[n].offsetLeft;v>=t+parseInt(u,10)?b(i.grid.bDiv)[0].scrollLeft=b(i.grid.bDiv)[0].scrollLeft+i.rows[d].cells[n].clientWidth:u>w&&(b(i.grid.bDiv)[0].scrollLeft=b(i.grid.bDiv)[0].scrollLeft-i.rows[d].cells[n].clientWidth)}}function h(d,f){var g,m;if("lft"===f){for(g=d+1,m=d;m>=0;m--){if(i.p.colModel[m].hidden!==!0){g=m;break}}}if("rgt"===f){for(g=d-1,m=d;m<i.p.colModel.length;m++){if(i.p.colModel[m].hidden!==!0){g=m;break}}}return g}var i=this;if(i.grid&&i.p.cellEdit===!0){i.p.knv=i.p.id+"_kn";var j,k,l=b("<div style='position:fixed;top:0px;width:1px;height:1px;' tabindex='0'><div tabindex='-1' style='width:1px;height:1px;' id='"+i.p.knv+"'></div></div>");b(l).insertBefore(i.grid.cDiv),b("#"+i.p.knv).focus().keydown(function(c){switch(k=c.keyCode,"rtl"===i.p.direction&&(37===k?k=39:39===k&&(k=37)),k){case 38:i.p.iRow-1>0&&(a(i.p.iRow-1,i.p.iCol,"vu"),b(i).jqGrid("editCell",i.p.iRow-1,i.p.iCol,!1));break;case 40:i.p.iRow+1<=i.rows.length-1&&(a(i.p.iRow+1,i.p.iCol,"vd"),b(i).jqGrid("editCell",i.p.iRow+1,i.p.iCol,!1));break;case 37:i.p.iCol-1>=0&&(j=h(i.p.iCol-1,"lft"),a(i.p.iRow,j,"h"),b(i).jqGrid("editCell",i.p.iRow,j,!1));break;case 39:i.p.iCol+1<=i.p.colModel.length-1&&(j=h(i.p.iCol+1,"rgt"),a(i.p.iRow,j,"h"),b(i).jqGrid("editCell",i.p.iRow,j,!1));break;case 13:parseInt(i.p.iCol,10)>=0&&parseInt(i.p.iRow,10)>=0&&b(i).jqGrid("editCell",i.p.iRow,i.p.iCol,!0);break;default:return !0}return !1})}})},getChangedCells:function(a){var d=[];return a||(a="all"),this.each(function(){var c,f=this;f.grid&&f.p.cellEdit===!0&&b(f.rows).each(function(e){var h={};b(this).hasClass("edited")&&(b("td",this).each(function(g){if(c=f.p.colModel[g].name,"cb"!==c&&"subgrid"!==c){if("dirty"===a){if(b(this).hasClass("dirty-cell")){try{h[c]=b.unformat.call(f,this,{rowId:f.rows[e].id,colModel:f.p.colModel[g]},g)}catch(i){h[c]=b.jgrid.htmlDecode(b(this).html())}}}else{try{h[c]=b.unformat.call(f,this,{rowId:f.rows[e].id,colModel:f.p.colModel[g]},g)}catch(i){h[c]=b.jgrid.htmlDecode(b(this).html())}}}}),h.id=this.id,d.push(h))})}),d}})});