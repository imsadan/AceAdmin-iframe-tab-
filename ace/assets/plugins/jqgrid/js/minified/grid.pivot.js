!function(b){"function"==typeof define&&define.amd?define(["jquery","./grid.base","./grid.grouping"],b):b(jQuery)}(function(c){function d(g,h){var i,j,k,l=[];if(!this||"function"!=typeof g||g instanceof RegExp){throw new TypeError}for(k=this.length,i=0;k>i;i++){if(this.hasOwnProperty(i)&&(j=this[i],g.call(h,j,i,this))){l.push(j);break}}return l}c.assocArraySize=function(e){var f,g=0;for(f in e){e.hasOwnProperty(f)&&g++}return g},c.jgrid.extend({pivotSetup:function(a,b){var m=[],n=[],o=[],p=[],q=[],r={grouping:!0,groupingView:{groupField:[],groupSummary:[],groupSummaryPos:[]}},s=[],t=c.extend({rowTotals:!1,rowTotalsText:"Total",colTotals:!1,groupSummary:!0,groupSummaryPos:"header",frozenStaticCols:!1},b||{});return this.each(function(){function h(u,v,w){var x;return x=d.call(u,v,w),x.length>0?x[0]:null}function V(u,v){var w,x=0,y=!0;for(w in u){if(u.hasOwnProperty(w)){if(u[w]!=this[x]){y=!1;break}if(x++,x>=this.length){break}}}return y&&(ae=v),y}function X(u,v,w,x,y){var z;switch(u){case"sum":z=parseFloat(v||0)+parseFloat(x[w]||0);break;case"count":(""===v||null==v)&&(v=0),z=x.hasOwnProperty(w)?v+1:0;break;case"min":z=""===v||null==v?parseFloat(x[w]||0):Math.min(parseFloat(v),parseFloat(x[w]||0));break;case"max":z=""===v||null==v?parseFloat(x[w]||0):Math.max(parseFloat(v),parseFloat(x[w]||0));break;case"avg":z=(parseFloat(v||0)*(y-1)+parseFloat(x[w]||0))/y}return z}function Z(u,v,w,x){var y,z,A,B,C=v.length,D="",E=[];for(c.isArray(w)?(B=w.length,E=w):(B=1,E[0]=w),p=[],q=[],p.root=0,x._count?x._count++:x._count=1,A=0;B>A;A++){var F,G=[];for(y=0;C>y;y++){if(null==w){z=c.trim(v[y].member)+"_"+v[y].aggregator,F=z,E[0]=v[y].label||v[y].aggregator+" "+c.trim(v[y].member)}else{F=w[A].replace(/\s+/g,"");try{z=1===C?D+F:D+F+"_"+v[y].aggregator+"_"+String(y)}catch(H){}E[A]=w[A]}z=isNaN(parseInt(z,10))?z:z+" ",x[z]=G[z]=X(v[y].aggregator,x[z],v[y].member,u,x._count)}D+=w[A].replace(/\s+/g,""),p[z]=G,q[z]=E[A]}return x}function ab(u){var v,w,x,y,z;for(x in u){if(u.hasOwnProperty(x)){if("object"!=typeof u[x]){if("level"===x){if(void 0===U[u.level]&&(U[u.level]="",u.level>0&&-1===u.text.indexOf("_r_Totals")&&(s[u.level-1]={useColSpanStyle:!1,groupHeaders:[]})),U[u.level]!==u.text&&u.children.length&&-1===u.text.indexOf("_r_Totals")&&u.level>0){s[u.level-1].groupHeaders.push({titleText:u.label,numberOfColumns:0});var A=s[u.level-1].groupHeaders.length-1,B=0===A?Y:W;if(u.level-1===(t.rowTotals?1:0)&&A>0){for(var C=0,D=0;A>D;D++){C+=s[u.level-1].groupHeaders[D].numberOfColumns}C&&(B=C+ag)}m[B]&&(s[u.level-1].groupHeaders[A].startColumnName=m[B].name,s[u.level-1].groupHeaders[A].numberOfColumns=m.length-B),W=m.length}U[u.level]=u.text}if(u.level===ah&&"level"===x&&ah>0){if(ai>1){var E=1;for(v in u.fields){u.fields.hasOwnProperty(v)&&(1===E&&s[ah-1].groupHeaders.push({startColumnName:v,numberOfColumns:1,titleText:u.label||u.text}),E++)}s[ah-1].groupHeaders[s[ah-1].groupHeaders.length-1].numberOfColumns=E-1}else{s.splice(ah-1,1)}}}if(null!=u[x]&&"object"==typeof u[x]&&ab(u[x]),"level"===x&&u.level>0&&(u.level===(0===ah?u.level:ah)||-1!==U[u.level].indexOf("_r_Totals"))){w=0;for(v in u.fields){if(u.fields.hasOwnProperty(v)){z={};for(y in t.aggregates[w]){if(t.aggregates[w].hasOwnProperty(y)){switch(y){case"member":case"label":case"aggregator":break;default:z[y]=t.aggregates[w][y]}}}ai>1?(z.name=v,z.label=t.aggregates[w].label||u.label):(z.name=u.text,z.label="_r_Totals"===u.text?t.rowTotalsText:u.label),m.push(z),w++}}}}}}var ad,ae,af,ag,ah,ai,aj,ak,al=a.length,am=0;if(t.rowTotals&&t.yDimension.length>0){var e=t.yDimension[0].dataName;t.yDimension.splice(0,0,{dataName:e}),t.yDimension[0].converter=function(){return"_r_Totals"}}if(ag=c.isArray(t.xDimension)?t.xDimension.length:0,ah=t.yDimension.length,ai=c.isArray(t.aggregates)?t.aggregates.length:0,0===ag||0===ai){throw"xDimension or aggregates optiona are not set!"}var f;for(af=0;ag>af;af++){f={name:t.xDimension[af].dataName,frozen:t.frozenStaticCols},null==t.xDimension[af].isGroupField&&(t.xDimension[af].isGroupField=!0),f=c.extend(!0,f,t.xDimension[af]),m.push(f)}for(var g=ag-1,i={};al>am;){ad=a[am];var j=[],k=[];aj={},af=0;do{j[af]=c.trim(ad[t.xDimension[af].dataName]),aj[t.xDimension[af].dataName]=j[af],af++}while(ag>af);var l=0;if(ae=-1,ak=h(n,V,j)){if(ae>=0){if(l=0,ah>=1){for(l=0;ah>l;l++){k[l]=c.trim(ad[t.yDimension[l].dataName]),t.yDimension[l].converter&&c.isFunction(t.yDimension[l].converter)&&(k[l]=t.yDimension[l].converter.call(this,k[l],j,k))}ak=Z(ad,t.aggregates,k,ak)}else{0===ah&&(ak=Z(ad,t.aggregates,null,ak))}n[ae]=ak}}else{if(l=0,ah>=1){for(l=0;ah>l;l++){k[l]=c.trim(ad[t.yDimension[l].dataName]),t.yDimension[l].converter&&c.isFunction(t.yDimension[l].converter)&&(k[l]=t.yDimension[l].converter.call(this,k[l],j,k))}aj=Z(ad,t.aggregates,k,aj)}else{0===ah&&(aj=Z(ad,t.aggregates,null,aj))}n.push(aj)}var Q,R=0,S=null,T=null;for(Q in p){if(p.hasOwnProperty(Q)){if(0===R){i.children&&void 0!==i.children||(i={text:Q,level:0,children:[],label:Q}),S=i.children}else{for(T=null,af=0;af<S.length;af++){if(S[af].text===Q){T=S[af];break}}T?S=T.children:(S.push({children:[],text:Q,level:R,fields:p[Q],label:q[Q]}),S=S[S.length-1].children)}R++}}am++}var U=[],W=m.length,Y=W;ah>0&&(s[ah-1]={useColSpanStyle:!1,groupHeaders:[]}),ab(i);var aa;if(t.colTotals){for(var ac=n.length;ac--;){for(af=ag;af<m.length;af++){aa=m[af].name,o[aa]?o[aa]+=parseFloat(n[ac][aa]||0):o[aa]=parseFloat(n[ac][aa]||0)}}}if(g>0){for(af=0;g>af;af++){m[af].isGroupField&&(r.groupingView.groupField.push(m[af].name),r.groupingView.groupSummary.push(t.groupSummary),r.groupingView.groupSummaryPos.push(t.groupSummaryPos))}}else{r.grouping=!1}r.sortname=m[g].name,r.groupingView.hideFirstGroupCol=!0}),{colModel:m,rows:n,groupOptions:r,groupHeaders:s,summary:o}},jqPivot:function(a,f,g,h){return this.each(function(){function b(n){var o,p,q,r,s=jQuery(e).jqGrid("pivotSetup",n,f),t=c.assocArraySize(s.summary)>0?!0:!1,u=c.jgrid.from.call(e,s.rows);for(f.ignoreCase&&(u=u.ignoreCase()),o=0;o<s.groupOptions.groupingView.groupField.length;o++){p=f.xDimension[o].sortorder?f.xDimension[o].sortorder:"asc",q=f.xDimension[o].sorttype?f.xDimension[o].sorttype:"text",u.orderBy(s.groupOptions.groupingView.groupField[o],p,q,"",q)}r=f.xDimension.length,s.groupOptions.sortname&&r&&(p=f.xDimension[r-1].sortorder?f.xDimension[r-1].sortorder:"asc",q=f.xDimension[r-1].sorttype?f.xDimension[r-1].sorttype:"text",u.orderBy(s.groupOptions.sortname,p,q,"",q)),jQuery(e).jqGrid(c.extend(!0,{datastr:c.extend(u.select(),t?{userdata:s.summary}:{}),datatype:"jsonstring",footerrow:t,userDataOnFooter:t,colModel:s.colModel,viewrecords:!0,sortname:f.xDimension[0].dataName},s.groupOptions,g||{}));var v=s.groupHeaders;if(v.length){for(o=0;o<v.length;o++){v[o]&&v[o].groupHeaders.length&&jQuery(e).jqGrid("setGroupHeaders",v[o])}}f.frozenStaticCols&&jQuery(e).jqGrid("setFrozenColumns")}var e=this;"string"==typeof a?c.ajax(c.extend({url:a,dataType:"json",success:function(i){b(c.jgrid.getAccessor(i,h&&h.reader?h.reader:"rows"))}},h||{})):b(a)})}})});