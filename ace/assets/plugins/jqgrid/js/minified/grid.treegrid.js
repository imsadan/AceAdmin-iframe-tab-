!function(b){"function"==typeof define&&define.amd?define(["jquery","./grid.base"],b):b(jQuery)}(function(b){b.jgrid.extend({setTreeNode:function(a,d){return this.each(function(){var c=this;if(c.grid&&c.p.treeGrid){for(var w,x,y,z,A,B,C,D,E=c.p.expColInd,F=c.p.treeReader.expanded_field,G=c.p.treeReader.leaf_field,H=c.p.treeReader.level_field,I=c.p.treeReader.icon_field,J=c.p.treeReader.loaded,K=b.jgrid.styleUI[c.p.styleUI||"jQueryUI"].common;d>a;){var L,M=b.jgrid.stripPref(c.p.idPrefix,c.rows[a].id),N=c.p._index[M];C=c.p.data[N],"nested"===c.p.treeGridModel&&(C[G]||(w=parseInt(C[c.p.treeReader.left_field],10),x=parseInt(C[c.p.treeReader.right_field],10),C[G]=x===w+1?"true":"false",c.rows[a].cells[c.p._treeleafpos].innerHTML=C[G])),y=parseInt(C[H],10),0===c.p.tree_root_level?(z=y+1,A=y):(z=y,A=y-1),B="<div class='tree-wrap tree-wrap-"+c.p.direction+"' style='width:"+18*z+"px;'>",B+="<div style='"+("rtl"===c.p.direction?"right:":"left:")+18*A+"px;' class='"+K.icon_base+" ",void 0!==C[J]&&("true"===C[J]||C[J]===!0?C[J]=!0:C[J]=!1),"true"===C[G]||C[G]===!0?(B+=(void 0!==C[I]&&""!==C[I]?C[I]:c.p.treeIcons.leaf)+" tree-leaf treeclick",C[G]=!0,D="leaf"):(C[G]=!1,D=""),C[F]=("true"===C[F]||C[F]===!0?!0:!1)&&(C[J]||void 0===C[J]),B+=C[F]===!1?C[G]===!0?"'":c.p.treeIcons.plus+" tree-plus treeclick'":C[G]===!0?"'":c.p.treeIcons.minus+" tree-minus treeclick'",B+="></div></div>",b(c.rows[a].cells[E]).wrapInner("<span class='cell-wrapper"+D+"'></span>").prepend(B),y!==parseInt(c.p.tree_root_level,10)&&(L=b(c).jqGrid("isVisibleNode",C),L||b(c.rows[a]).css("display","none")),b(c.rows[a].cells[E]).find("div.treeclick").bind("click",function(g){var h=g.target||g.srcElement,i=b.jgrid.stripPref(c.p.idPrefix,b(h,c.rows).closest("tr.jqgrow")[0].id),j=c.p._index[i];return c.p.data[j][G]||(c.p.data[j][F]?(b(c).jqGrid("collapseRow",c.p.data[j]),b(c).jqGrid("collapseNode",c.p.data[j])):(b(c).jqGrid("expandRow",c.p.data[j]),b(c).jqGrid("expandNode",c.p.data[j]))),!1}),c.p.ExpandColClick===!0&&b(c.rows[a].cells[E]).find("span.cell-wrapper").css("cursor","pointer").bind("click",function(g){var h=g.target||g.srcElement,i=b.jgrid.stripPref(c.p.idPrefix,b(h,c.rows).closest("tr.jqgrow")[0].id),j=c.p._index[i];return c.p.data[j][G]||(c.p.data[j][F]?(b(c).jqGrid("collapseRow",c.p.data[j]),b(c).jqGrid("collapseNode",c.p.data[j])):(b(c).jqGrid("expandRow",c.p.data[j]),b(c).jqGrid("expandNode",c.p.data[j]))),b(c).jqGrid("setSelection",i),!1}),a++}}})},setTreeGrid:function(){return this.each(function(){var a,k,l,m,n=this,o=0,p=!1,q=[],r=b.jgrid.styleUI[n.p.styleUI||"jQueryUI"].treegrid;if(n.p.treeGrid){n.p.treedatatype||b.extend(n.p,{treedatatype:n.p.datatype}),n.p.loadonce&&(n.p.treedatatype="local"),n.p.subGrid=!1,n.p.altRows=!1,n.p.pgbuttons=!1,n.p.pginput=!1,n.p.gridview=!0,null===n.p.rowTotal&&(n.p.rowNum=10000),n.p.multiselect=!1,n.p.rowList=[],n.p.expColInd=0,a=r.icon_plus,"jQueryUI"===n.p.styleUI&&(a+="rtl"===n.p.direction?"w":"e"),n.p.treeIcons=b.extend({plus:a,minus:r.icon_minus,leaf:r.icon_leaf},n.p.treeIcons||{}),"nested"===n.p.treeGridModel?n.p.treeReader=b.extend({level_field:"level",left_field:"lft",right_field:"rgt",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",icon_field:"icon"},n.p.treeReader):"adjacency"===n.p.treeGridModel&&(n.p.treeReader=b.extend({level_field:"level",parent_id_field:"parent",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",icon_field:"icon"},n.p.treeReader));for(l in n.p.colModel){if(n.p.colModel.hasOwnProperty(l)){k=n.p.colModel[l].name,k!==n.p.ExpandColumn||p||(p=!0,n.p.expColInd=o),o++;for(m in n.p.treeReader){n.p.treeReader.hasOwnProperty(m)&&n.p.treeReader[m]===k&&q.push(k)}}}b.each(n.p.treeReader,function(d,e){e&&-1===b.inArray(e,q)&&("leaf_field"===d&&(n.p._treeleafpos=o),o++,n.p.colNames.push(e),n.p.colModel.push({name:e,width:1,hidden:!0,sortable:!1,resizable:!1,hidedlg:!0,editable:!0,search:!1}))})}})},expandRow:function(a){this.each(function(){var h=this;if(h.grid&&h.p.treeGrid){var i=b(h).jqGrid("getNodeChildren",a),j=h.p.treeReader.expanded_field,k=a[h.p.localReader.id],l=b.isFunction(h.p.beforeExpandTreeGridRow)?h.p.beforeExpandTreeGridRow.call(h,k,a,i):!0;l!==!1&&(b(i).each(function(){var c=h.p.idPrefix+b.jgrid.getAccessor(this,h.p.localReader.id);b(b(h).jqGrid("getGridRowById",c)).css("display",""),this[j]&&b(h).jqGrid("expandRow",this)}),b.isFunction(h.p.afterExpandTreeGridRow)&&h.p.afterExpandTreeGridRow.call(h,k,a,i))}})},collapseRow:function(a){this.each(function(){var h=this;if(h.grid&&h.p.treeGrid){var i=b(h).jqGrid("getNodeChildren",a),j=h.p.treeReader.expanded_field,k=a[h.p.localReader.id],l=b.isFunction(h.p.beforeCollapseTreeGridRow)?h.p.beforeCollapseTreeGridRow.call(h,k,a,i):!0;l!==!1&&(b(i).each(function(){var c=h.p.idPrefix+b.jgrid.getAccessor(this,h.p.localReader.id);b(b(h).jqGrid("getGridRowById",c)).css("display","none"),this[j]&&b(h).jqGrid("collapseRow",this)}),b.isFunction(h.p.afterCollapseTreeGridRow)&&h.p.afterCollapseTreeGridRow.call(h,k,a,i))}})},getRootNodes:function(a){var d=[];return this.each(function(){var c,h,i,j=this;if(j.grid&&j.p.treeGrid){switch("boolean"!=typeof a&&(a=!1),i=a?b(j).jqGrid("getRowData",null,!0):j.p.data,j.p.treeGridModel){case"nested":c=j.p.treeReader.level_field,b(i).each(function(){parseInt(this[c],10)===parseInt(j.p.tree_root_level,10)&&(a?d.push(j.p.data[j.p._index[this[j.p.keyName]]]):d.push(this))});break;case"adjacency":h=j.p.treeReader.parent_id_field,b(i).each(function(){(null===this[h]||"null"===String(this[h]).toLowerCase())&&(a?d.push(j.p.data[j.p._index[this[j.p.keyName]]]):d.push(this))})}}}),d},getNodeDepth:function(a){var d=null;return this.each(function(){if(this.grid&&this.p.treeGrid){var c=this;switch(c.p.treeGridModel){case"nested":var f=c.p.treeReader.level_field;d=parseInt(a[f],10)-parseInt(c.p.tree_root_level,10);break;case"adjacency":d=b(c).jqGrid("getNodeAncestors",a).length}}}),d},getNodeParent:function(a){var d=null;return this.each(function(){var c=this;if(c.grid&&c.p.treeGrid){switch(c.p.treeGridModel){case"nested":var o=c.p.treeReader.left_field,p=c.p.treeReader.right_field,q=c.p.treeReader.level_field,r=parseInt(a[o],10),s=parseInt(a[p],10),t=parseInt(a[q],10);b(this.p.data).each(function(){return parseInt(this[q],10)===t-1&&parseInt(this[o],10)<r&&parseInt(this[p],10)>s?(d=this,!1):void 0});break;case"adjacency":for(var u=c.p.treeReader.parent_id_field,v=c.p.localReader.id,w=a[v],x=c.p._index[w];x--;){if(c.p.data[x][v]===b.jgrid.stripPref(c.p.idPrefix,a[u])){d=c.p.data[x];break}}}}}),d},getNodeChildren:function(a){var d=[];return this.each(function(){var c=this;if(c.grid&&c.p.treeGrid){switch(c.p.treeGridModel){case"nested":var m=c.p.treeReader.left_field,n=c.p.treeReader.right_field,o=c.p.treeReader.level_field,p=parseInt(a[m],10),q=parseInt(a[n],10),r=parseInt(a[o],10);b(this.p.data).each(function(){parseInt(this[o],10)===r+1&&parseInt(this[m],10)>p&&parseInt(this[n],10)<q&&d.push(this)});break;case"adjacency":var s=c.p.treeReader.parent_id_field,t=c.p.localReader.id;b(this.p.data).each(function(){this[s]==b.jgrid.stripPref(c.p.idPrefix,a[t])&&d.push(this)})}}}),d},getFullTreeNode:function(a,e){var f=[];return this.each(function(){var c,d=this,p=d.p.treeReader.expanded_field;if(d.grid&&d.p.treeGrid){switch((null==e||"boolean"!=typeof e)&&(e=!1),d.p.treeGridModel){case"nested":var q=d.p.treeReader.left_field,r=d.p.treeReader.right_field,s=d.p.treeReader.level_field,t=parseInt(a[q],10),u=parseInt(a[r],10),v=parseInt(a[s],10);b(this.p.data).each(function(){parseInt(this[s],10)>=v&&parseInt(this[q],10)>=t&&parseInt(this[q],10)<=u&&(e&&(this[p]=!0),f.push(this))});break;case"adjacency":if(a){f.push(a);var w=d.p.treeReader.parent_id_field,x=d.p.localReader.id;b(this.p.data).each(function(g){for(c=f.length,g=0;c>g;g++){if(b.jgrid.stripPref(d.p.idPrefix,f[g][x])===this[w]){e&&(this[p]=!0),f.push(this);break}}})}}}}),f},getNodeAncestors:function(a){var d=[];return this.each(function(){if(this.grid&&this.p.treeGrid){for(var c=b(this).jqGrid("getNodeParent",a);c;){d.push(c),c=b(this).jqGrid("getNodeParent",c)}}}),d},isVisibleNode:function(a){var d=!0;return this.each(function(){var c=this;if(c.grid&&c.p.treeGrid){var g=b(c).jqGrid("getNodeAncestors",a),h=c.p.treeReader.expanded_field;b(g).each(function(){return d=d&&this[h],d?void 0:!1})}}),d},isNodeLoaded:function(a){var d;return this.each(function(){var c=this;if(c.grid&&c.p.treeGrid){var g=c.p.treeReader.leaf_field,h=c.p.treeReader.loaded;d=void 0!==a?void 0!==a[h]?a[h]:a[g]||b(c).jqGrid("getNodeChildren",a).length>0?!0:!1:!1}}),d},reloadNode:function(a){return this.each(function(){if(this.grid&&this.p.treeGrid){var m=this.p.localReader.id,n=this.p.selrow;b(this).jqGrid("delChildren",a[m]);var o=this.p.treeReader.expanded_field,p=this.p.treeReader.parent_id_field,q=this.p.treeReader.loaded,r=this.p.treeReader.level_field,s=this.p.treeReader.left_field,t=this.p.treeReader.right_field,u=b.jgrid.getAccessor(a,this.p.localReader.id),v=b("#"+u,this.grid.bDiv)[0];a[o]=!0,b("div.treeclick",v).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus"),this.p.treeANode=v.rowIndex,this.p.datatype=this.p.treedatatype,"nested"===this.p.treeGridModel?b(this).jqGrid("setGridParam",{postData:{nodeid:u,n_left:a[s],n_right:a[t],n_level:a[r]}}):b(this).jqGrid("setGridParam",{postData:{nodeid:u,parentid:a[p],n_level:a[r]}}),b(this).trigger("reloadGrid"),a[q]=!0,"nested"===this.p.treeGridModel?b(this).jqGrid("setGridParam",{selrow:n,postData:{nodeid:"",n_left:"",n_right:"",n_level:""}}):b(this).jqGrid("setGridParam",{selrow:n,postData:{nodeid:"",parentid:"",n_level:""}})}})},expandNode:function(a){return this.each(function(){if(this.grid&&this.p.treeGrid){var m=this.p.treeReader.expanded_field,n=this.p.treeReader.parent_id_field,o=this.p.treeReader.loaded,p=this.p.treeReader.level_field,q=this.p.treeReader.left_field,r=this.p.treeReader.right_field;if(!a[m]){var s=b.jgrid.getAccessor(a,this.p.localReader.id),t=b("#"+this.p.idPrefix+b.jgrid.jqID(s),this.grid.bDiv)[0],u=this.p._index[s],v=b.isFunction(this.p.beforeExpandTreeGridNode)?this.p.beforeExpandTreeGridNode.call(this,s,a):!0;if(v===!1){return}b(this).jqGrid("isNodeLoaded",this.p.data[u])?(a[m]=!0,b("div.treeclick",t).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus")):this.grid.hDiv.loading||(a[m]=!0,b("div.treeclick",t).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus"),this.p.treeANode=t.rowIndex,this.p.datatype=this.p.treedatatype,"nested"===this.p.treeGridModel?b(this).jqGrid("setGridParam",{postData:{nodeid:s,n_left:a[q],n_right:a[r],n_level:a[p]}}):b(this).jqGrid("setGridParam",{postData:{nodeid:s,parentid:a[n],n_level:a[p]}}),b(this).trigger("reloadGrid"),a[o]=!0,"nested"===this.p.treeGridModel?b(this).jqGrid("setGridParam",{postData:{nodeid:"",n_left:"",n_right:"",n_level:""}}):b(this).jqGrid("setGridParam",{postData:{nodeid:"",parentid:"",n_level:""}})),b.isFunction(this.p.afterExpandTreeGridNode)&&this.p.afterExpandTreeGridNode.call(this,s,a)}}})},collapseNode:function(a){return this.each(function(){if(this.grid&&this.p.treeGrid){var g=this.p.treeReader.expanded_field;if(a[g]){var h=b.jgrid.getAccessor(a,this.p.localReader.id),i=b.isFunction(this.p.beforeCollapseTreeGridNode)?this.p.beforeCollapseTreeGridNode.call(this,h,a):!0,j=b("#"+this.p.idPrefix+b.jgrid.jqID(h),this.grid.bDiv)[0];if(a[g]=!1,i===!1){return}b("div.treeclick",j).removeClass(this.p.treeIcons.minus+" tree-minus").addClass(this.p.treeIcons.plus+" tree-plus"),b.isFunction(this.p.afterCollapseTreeGridNode)&&this.p.afterCollapseTreeGridNode.call(this,h,a)}}})},SortTree:function(a,f,g,h){return this.each(function(){if(this.grid&&this.p.treeGrid){var c,d,e,n,o,p=[],q=this,r=b(this).jqGrid("getRootNodes",q.p.search);for(n=b.jgrid.from.call(this,r),n.orderBy(a,f,g,h),o=n.select(),c=0,d=o.length;d>c;c++){e=o[c],p.push(e),b(this).jqGrid("collectChildrenSortTree",p,e,a,f,g,h)}b.each(p,function(i){var j=b.jgrid.getAccessor(this,q.p.localReader.id);b("#"+b.jgrid.jqID(q.p.id)+" tbody tr:eq("+i+")").after(b("tr#"+b.jgrid.jqID(j),q.grid.bDiv))}),n=null,o=null,p=null}})},searchTree:function(a){var j,k,l,m=a.length||0,n=[],o=[],p=[];return this.each(function(){if(this.grid&&this.p.treeGrid&&m){for(k=this.p.localReader.id,j=0;m>j;j++){n=b(this).jqGrid("getNodeAncestors",a[j]),n.length||n.push(a[j]),l=n[n.length-1][k],-1===b.inArray(l,o)&&(o.push(l),n=b(this).jqGrid("getFullTreeNode",n[n.length-1],!0),p=p.concat(n))}}}),p},collectChildrenSortTree:function(a,h,i,j,k,l){return this.each(function(){if(this.grid&&this.p.treeGrid){var c,d,e,f,g,n;for(f=b(this).jqGrid("getNodeChildren",h),g=b.jgrid.from.call(this,f),g.orderBy(i,j,k,l),n=g.select(),c=0,d=n.length;d>c;c++){e=n[c],a.push(e),b(this).jqGrid("collectChildrenSortTree",a,e,i,j,k,l)}}})},setTreeRow:function(a,e){var f=!1;return this.each(function(){var c=this;c.grid&&c.p.treeGrid&&(f=b(c).jqGrid("setRowData",a,e))}),f},delTreeNode:function(a){return this.each(function(){var n,o,p,q,r,s=this,t=s.p.localReader.id,u=s.p.treeReader.left_field,v=s.p.treeReader.right_field;if(s.grid&&s.p.treeGrid){var w=s.p._index[a];if(void 0!==w){o=parseInt(s.p.data[w][v],10),p=o-parseInt(s.p.data[w][u],10)+1;var x=b(s).jqGrid("getFullTreeNode",s.p.data[w]);if(x.length>0){for(n=0;n<x.length;n++){b(s).jqGrid("delRowData",x[n][t])}}if("nested"===s.p.treeGridModel){if(q=b.jgrid.from.call(s,s.p.data).greater(u,o,{stype:"integer"}).select(),q.length){for(r in q){q.hasOwnProperty(r)&&(q[r][u]=parseInt(q[r][u],10)-p)}}if(q=b.jgrid.from.call(s,s.p.data).greater(v,o,{stype:"integer"}).select(),q.length){for(r in q){q.hasOwnProperty(r)&&(q[r][v]=parseInt(q[r][v],10)-p)}}}}}})},delChildren:function(a){return this.each(function(){var n,o,p,q,r=this,s=r.p.localReader.id,t=r.p.treeReader.left_field,u=r.p.treeReader.right_field;if(r.grid&&r.p.treeGrid){var v=r.p._index[a];if(void 0!==v){n=parseInt(r.p.data[v][u],10),o=n-parseInt(r.p.data[v][t],10)+1;var w=b(r).jqGrid("getFullTreeNode",r.p.data[v]);if(w.length>0){for(var x=0;x<w.length;x++){w[x][s]!==a&&b(r).jqGrid("delRowData",w[x][s])}}if("nested"===r.p.treeGridModel){if(p=b.jgrid.from(r.p.data).greater(t,n,{stype:"integer"}).select(),p.length){for(q in p){p.hasOwnProperty(q)&&(p[q][t]=parseInt(p[q][t],10)-o)}}if(p=b.jgrid.from(r.p.data).greater(u,n,{stype:"integer"}).select(),p.length){for(q in p){p.hasOwnProperty(q)&&(p[q][u]=parseInt(p[q][u],10)-o)}}}}}})},addChildNode:function(C,E,F,G){var H=this[0];if(F){var I,J,K,L,M,N,O,P,Q=H.p.treeReader.expanded_field,R=H.p.treeReader.leaf_field,S=H.p.treeReader.level_field,T=H.p.treeReader.parent_id_field,U=H.p.treeReader.left_field,V=H.p.treeReader.right_field,W=H.p.treeReader.loaded,X=0,Y=E;if(void 0===G&&(G=!1),null==C){if(M=H.p.data.length-1,M>=0){for(;M>=0;){X=Math.max(X,parseInt(H.p.data[M][H.p.localReader.id],10)),M--}}C=X+1}var Z=b(H).jqGrid("getInd",E);if(O=!1,void 0===E||null===E||""===E){E=null,Y=null,I="last",L=H.p.tree_root_level,M=H.p.data.length+1}else{I="after",J=H.p._index[E],K=H.p.data[J],E=K[H.p.localReader.id],L=parseInt(K[S],10)+1;var aa=b(H).jqGrid("getFullTreeNode",K);aa.length?(M=aa[aa.length-1][H.p.localReader.id],Y=M,M=b(H).jqGrid("getInd",Y)+1):M=b(H).jqGrid("getInd",E)+1,K[R]&&(O=!0,K[Q]=!0,b(H.rows[Z]).find("span.cell-wrapperleaf").removeClass("cell-wrapperleaf").addClass("cell-wrapper").end().find("div.tree-leaf").removeClass(H.p.treeIcons.leaf+" tree-leaf").addClass(H.p.treeIcons.minus+" tree-minus"),H.p.data[J][R]=!1,K[W]=!0)}if(N=M+1,void 0===F[Q]&&(F[Q]=!1),void 0===F[W]&&(F[W]=!1),F[S]=L,void 0===F[R]&&(F[R]=!0),"adjacency"===H.p.treeGridModel&&(F[T]=E),"nested"===H.p.treeGridModel){var ab,a,D;if(null!==E){if(P=parseInt(K[V],10),ab=b.jgrid.from.call(H,H.p.data),ab=ab.greaterOrEquals(V,P,{stype:"integer"}),a=ab.select(),a.length){for(D in a){a.hasOwnProperty(D)&&(a[D][U]=a[D][U]>P?parseInt(a[D][U],10)+2:a[D][U],a[D][V]=a[D][V]>=P?parseInt(a[D][V],10)+2:a[D][V])}}F[U]=P,F[V]=P+1}else{if(P=parseInt(b(H).jqGrid("getCol",V,!1,"max"),10),a=b.jgrid.from.call(H,H.p.data).greater(U,P,{stype:"integer"}).select(),a.length){for(D in a){a.hasOwnProperty(D)&&(a[D][U]=parseInt(a[D][U],10)+2)}}if(a=b.jgrid.from.call(H,H.p.data).greater(V,P,{stype:"integer"}).select(),a.length){for(D in a){a.hasOwnProperty(D)&&(a[D][V]=parseInt(a[D][V],10)+2)}}F[U]=P+1,F[V]=P+2}}(null===E||b(H).jqGrid("isNodeLoaded",K)||O)&&(b(H).jqGrid("addRowData",C,F,I,Y),b(H).jqGrid("setTreeNode",M,N)),K&&!K[Q]&&G&&b(H.rows[Z]).find("div.treeclick").click()}}})});